---
phase: 13-slack-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/check-notification/index.ts
  - src/lib/slack.ts
autonomous: true
user_setup:
  - service: slack
    why: "OAuth app for workspace connection"
    env_vars:
      - name: SLACK_CLIENT_ID
        source: "Slack API -> Your Apps -> Basic Information -> App Credentials"
      - name: SLACK_CLIENT_SECRET
        source: "Slack API -> Your Apps -> Basic Information -> App Credentials"
    dashboard_config:
      - task: "Add redirect URL to Slack app"
        location: "Slack API -> Your Apps -> OAuth & Permissions -> Redirect URLs"
        value: "https://axidex.vercel.app/api/slack/callback"

must_haves:
  truths:
    - "High-priority signals trigger Slack notification automatically"
    - "Slack notification only sent when slack_enabled is true"
    - "Slack notification respects same priority/type filters as email"
  artifacts:
    - path: "supabase/functions/check-notification/index.ts"
      provides: "Slack notification logic in Edge Function"
      contains: "postToSlack"
  key_links:
    - from: "supabase/functions/check-notification/index.ts"
      to: "Slack API"
      via: "fetch to chat.postMessage"
      pattern: "slack\\.com/api/chat\\.postMessage"
---

<objective>
Add automatic Slack notifications to the Edge Function that already handles email notifications.

Purpose: Complete SLCK-03 - when a high-priority signal is inserted, users with Slack enabled receive instant Slack messages in their selected channel.

Output: Updated Edge Function with Slack posting capability.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing Slack implementation
@src/lib/slack.ts
@src/app/api/slack/test/route.ts
@supabase/functions/check-notification/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Slack notification to Edge Function</name>
  <files>supabase/functions/check-notification/index.ts</files>
  <action>
Update the Edge Function to send Slack notifications after the email notification logic:

1. Add profile fields to the SELECT query:
   - `slack_access_token`
   - `slack_channel_id`
   - `slack_enabled`

2. After the email notification is sent (or skipped), add Slack notification logic:
   - Check if `slack_enabled` is true AND `slack_access_token` exists AND `slack_channel_id` exists
   - If yes, call the Slack chat.postMessage API directly (cannot import from src/lib in Deno)
   - Use the same message format as lib/slack.ts (copy the buildSignalMessage logic inline)
   - Include priority emoji, type emoji, signal details, and "View in Dashboard" button
   - Log success/failure to console

3. Update the response to include both `emailSent` and `slackSent` booleans

Important: The Edge Function runs in Deno, so cannot import from src/lib. Must inline the Slack message building logic.
  </action>
  <verify>
1. `npx supabase functions serve check-notification` starts without errors
2. Review code to confirm Slack posting logic is present
3. TypeScript compilation passes
  </verify>
  <done>
Edge Function includes Slack notification logic that:
- Fetches slack_* fields from profile
- Checks slack_enabled before posting
- Builds rich Block Kit message with signal details
- Posts to Slack API with user's access token
- Returns both emailSent and slackSent in response
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Deno types and deploy Edge Function</name>
  <files>supabase/functions/check-notification/index.ts</files>
  <action>
1. Ensure proper Deno typing for the Slack API response:
   ```typescript
   interface SlackPostResult {
     ok: boolean;
     error?: string;
   }
   ```

2. Add error handling for Slack API failures:
   - Log errors but don't fail the entire function (Slack is non-critical)
   - Return `slackSent: false` with `slackError` if failed

3. Deploy the updated Edge Function to Supabase:
   ```bash
   npx supabase functions deploy check-notification
   ```

4. If deployment requires authentication, note the command to run after user authenticates:
   ```bash
   npx supabase login
   npx supabase link --project-ref <project-ref>
   npx supabase functions deploy check-notification
   ```
  </action>
  <verify>
1. `npx supabase functions deploy check-notification` succeeds (or provides clear next steps for auth)
2. Function appears in Supabase dashboard under Edge Functions
  </verify>
  <done>
Edge Function deployed to production with Slack notification capability.
  </done>
</task>

</tasks>

<verification>
1. Connect Slack workspace in settings (if not already connected)
2. Select a channel and enable Slack notifications
3. Trigger a new high-priority signal insertion (via worker or manual API call)
4. Verify Slack message appears in selected channel within 5 minutes
5. Verify message includes:
   - Priority emoji (red circle for high)
   - Company name and signal title
   - Signal summary
   - "View in Dashboard" button with correct link
   - Source attribution
</verification>

<success_criteria>
- SLCK-03: High-priority signals posted to Slack automatically
- Slack respects same notification preferences as email
- Non-blocking: Slack failures don't break email notifications
- Message format matches existing test notification (lib/slack.ts)
</success_criteria>

<output>
After completion, create `.planning/phases/13-slack-integration/13-01-SUMMARY.md`
</output>

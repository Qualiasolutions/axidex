---
phase: 15-onboarding
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/components/onboarding/setup-wizard.tsx
  - src/components/onboarding/onboarding-provider.tsx
  - src/app/dashboard/layout.tsx
  - src/app/dashboard/page.tsx
  - src/components/layout/sidebar.tsx
  - src/app/dashboard/settings/page.tsx
autonomous: false

must_haves:
  truths:
    - "Setup wizard appears after tour completes"
    - "User can toggle email notifications on/off"
    - "User can select signal types to track"
    - "Completing wizard saves preferences to profiles"
    - "User can restart onboarding from settings page"
    - "Onboarding only shows once per user (persisted)"
  artifacts:
    - path: "src/components/onboarding/setup-wizard.tsx"
      provides: "Multi-step notification preferences wizard"
      exports: ["SetupWizard"]
    - path: "src/components/onboarding/onboarding-provider.tsx"
      provides: "Context provider wrapping onboarding flow"
      exports: ["OnboardingProvider"]
    - path: "src/app/dashboard/layout.tsx"
      provides: "Dashboard layout with OnboardingProvider"
      contains: "OnboardingProvider"
  key_links:
    - from: "src/components/onboarding/onboarding-provider.tsx"
      to: "src/hooks/use-onboarding.ts"
      via: "import and consume hook"
      pattern: "useOnboarding"
    - from: "src/components/onboarding/onboarding-provider.tsx"
      to: "WelcomeModal, FeatureTour, SetupWizard"
      via: "renders based on phase"
      pattern: "phase.*===.*welcome"
    - from: "src/app/dashboard/layout.tsx"
      to: "OnboardingProvider"
      via: "wraps children"
      pattern: "<OnboardingProvider>"
---

<objective>
Build setup wizard and integrate full onboarding flow into dashboard.

Purpose: ONBR-03 - Setup wizard configures initial notification preferences. Integrates all onboarding components (welcome, tour, wizard) into a coherent flow triggered for new users.

Output: SetupWizard component, OnboardingProvider context, dashboard integration with tour target IDs, settings page "restart tour" option.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-onboarding/15-RESEARCH.md
@.planning/phases/15-onboarding/15-01-SUMMARY.md

# Components from previous plan
@src/hooks/use-onboarding.ts
@src/components/onboarding/welcome-modal.tsx
@src/components/onboarding/feature-tour.tsx

# Existing files to modify
@src/app/dashboard/layout.tsx
@src/app/dashboard/page.tsx
@src/components/layout/sidebar.tsx
@src/app/dashboard/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build SetupWizard for notification preferences</name>
  <files>
    src/components/onboarding/setup-wizard.tsx
  </files>
  <action>
Create a 2-step wizard modal for configuring notification preferences.

Props:
```typescript
interface SetupWizardProps {
  isOpen: boolean;
  onComplete: () => void;
  onSkip: () => void;
}
```

**Step 1: Email Notifications**
- Bell icon header
- Title: "Email Notifications"
- Description: "Get notified when new buying signals are detected for your target accounts."
- Toggle for enabling/disabling email alerts (visual toggle, not HTML checkbox)
- Default: enabled

**Step 2: Signal Types**
- MessageSquare icon header
- Title: "Signal Types"
- Description: "Choose which types of signals you want to track."
- Grid of 4 selectable signal types with checkboxes:
  - hiring: "Hiring" / "Job postings, team growth"
  - funding: "Funding" / "Investment rounds"
  - expansion: "Expansion" / "New markets"
  - partnership: "Partnership" / "Strategic partnerships"
- Default: all selected

**UI Requirements:**
- Step indicator bar (2 segments, colored based on current step)
- AnimatePresence for step transitions (slide left/right)
- "Skip setup" ghost button and "Continue/Complete Setup" primary button
- "Back" button on step 2
- On complete: save to profiles.notification_preferences as JSONB:
  ```json
  {
    "email_enabled": true,
    "signal_types": ["hiring", "funding", "expansion", "partnership"],
    "priority_threshold": "high"
  }
  ```
- Use existing Supabase client pattern from project
- Show loading state while saving ("Saving...")
  </action>
  <verify>
- File exists at src/components/onboarding/setup-wizard.tsx
- `npx tsc --noEmit` passes
- Export: `SetupWizard`
  </verify>
  <done>
SetupWizard provides 2-step notification preferences configuration with visual toggles and saves to profiles table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OnboardingProvider and integrate into dashboard</name>
  <files>
    src/components/onboarding/onboarding-provider.tsx
    src/app/dashboard/layout.tsx
    src/app/dashboard/page.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
**Create src/components/onboarding/onboarding-provider.tsx:**

Client component that:
1. Wraps children with onboarding flow overlay
2. Uses useOnboarding hook for state
3. Renders appropriate component based on phase:
   - idle: nothing (user completed or loading)
   - welcome: WelcomeModal
   - tour: FeatureTour
   - wizard: SetupWizard
   - complete: nothing (briefly, then sets to idle)

4. Orchestrates transitions:
   - On mount: if !hasCompletedOnboarding && !isLoading, set phase to 'welcome'
   - WelcomeModal onStartTour -> phase 'tour'
   - WelcomeModal onSkip -> completeOnboarding() -> phase 'idle'
   - FeatureTour onComplete -> phase 'wizard'
   - FeatureTour onSkip -> completeOnboarding() -> phase 'idle'
   - SetupWizard onComplete -> completeOnboarding() -> phase 'idle'
   - SetupWizard onSkip -> completeOnboarding() -> phase 'idle'

**Update src/app/dashboard/layout.tsx:**

Wrap children with OnboardingProvider:
```tsx
import { OnboardingProvider } from "@/components/onboarding/onboarding-provider";

// In the return:
<OnboardingProvider>
  <div className="lg:ml-60 min-h-screen transition-all duration-300 pt-14 lg:pt-0">
    {children}
  </div>
</OnboardingProvider>
```

**Update src/app/dashboard/page.tsx:**

Add id="btn-run-scraper" to the Run Scraper button for tour targeting:
```tsx
<Button
  id="btn-run-scraper"  // Add this
  onClick={handleRunScraper}
  ...
>
```

**Update src/components/layout/sidebar.tsx:**

Add IDs to nav links for tour targeting:
- Signals link: id="nav-signals"
- Emails link: id="nav-emails"

Find the NavLink component or individual Link elements and add:
```tsx
id="nav-signals"  // on the Signals nav item
id="nav-emails"   // on the Emails nav item
```
  </action>
  <verify>
- OnboardingProvider exports from onboarding-provider.tsx
- dashboard/layout.tsx imports and uses OnboardingProvider
- dashboard/page.tsx has id="btn-run-scraper" on button
- sidebar.tsx has id="nav-signals" and id="nav-emails" on nav items
- `npx tsc --noEmit` passes
  </verify>
  <done>
OnboardingProvider orchestrates welcome->tour->wizard flow. Dashboard layout integrated. Tour target IDs added to sidebar and dashboard.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add restart tour option to settings page</name>
  <files>
    src/app/dashboard/settings/page.tsx
  </files>
  <action>
Add a "Restart Onboarding Tour" option to the settings page.

Find an appropriate section (likely near the bottom, or create a new "Help" section).

Add a card/section with:
- Title: "Onboarding Tour"
- Description: "New to Axidex? Restart the onboarding tour to learn about key features."
- Button: "Restart Tour" (outline variant)

Button onClick:
1. Import and use resetOnboarding from useOnboarding hook
2. Call resetOnboarding()
3. Show toast: "Tour restarted! Refresh the page to begin."
4. Optionally redirect to /dashboard after brief delay

Implementation pattern:
```tsx
import { useOnboarding } from "@/hooks/use-onboarding";
import { toast } from "sonner";

// In component:
const { resetOnboarding } = useOnboarding();

const handleRestartTour = async () => {
  await resetOnboarding();
  toast.success("Tour restarted! Refresh the page to begin.");
  // Optional: router.push('/dashboard') after delay
};
```

Place this near the end of the settings page, as a separate card/section.
  </action>
  <verify>
- settings/page.tsx has "Restart Tour" functionality
- `npx tsc --noEmit` passes
- No duplicate imports
  </verify>
  <done>
Settings page includes "Restart Tour" option that clears onboarding_completed_at and prompts user to refresh.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify complete onboarding flow</name>
  <what-built>
Complete onboarding experience with:
- Welcome modal for new users
- 3-step feature tour (Signals, Scraper, Emails)
- 2-step setup wizard (notifications, signal types)
- Settings page restart option
  </what-built>
  <how-to-verify>
1. Reset your onboarding state:
   - Go to Settings page
   - Click "Restart Tour"
   - Refresh the page

2. Verify Welcome Modal:
   - Modal should appear with "Welcome to Axidex"
   - Click "Start Quick Tour"

3. Verify Feature Tour:
   - Step 1: Signals nav item highlighted, tooltip visible
   - Click "Next"
   - Step 2: Run Scraper button highlighted
   - Click "Next"
   - Step 3: Emails nav item highlighted
   - Click "Finish"

4. Verify Setup Wizard:
   - Step 1: Email toggle appears, can toggle on/off
   - Click "Continue"
   - Step 2: Signal types grid, can select/deselect
   - Click "Complete Setup"

5. Verify Persistence:
   - Refresh page - onboarding should NOT reappear
   - Check Settings - should show "Restart Tour" option

6. Verify Skip Flow:
   - Restart tour again
   - Click "Skip for now" on welcome modal
   - Verify it doesn't reappear on refresh
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. All files exist and compile:
   - src/components/onboarding/setup-wizard.tsx
   - src/components/onboarding/onboarding-provider.tsx
   - Updated: layout.tsx, page.tsx, sidebar.tsx, settings/page.tsx

2. TypeScript: `npx tsc --noEmit` passes

3. Tour target IDs in DOM:
   - id="nav-signals" on sidebar
   - id="nav-emails" on sidebar
   - id="btn-run-scraper" on dashboard

4. Complete flow works: Welcome -> Tour (3 steps) -> Wizard (2 steps) -> Complete
</verification>

<success_criteria>
- [ ] SetupWizard has 2 steps (email toggle, signal types)
- [ ] OnboardingProvider renders correct component per phase
- [ ] Dashboard layout wrapped with OnboardingProvider
- [ ] Tour target IDs added to sidebar and dashboard
- [ ] Settings page has "Restart Tour" option
- [ ] Onboarding persists to database (doesn't reappear on refresh)
- [ ] Skip flow works and persists
- [ ] Human verification confirms visual/functional quality
</success_criteria>

<output>
After completion, create `.planning/phases/15-onboarding/15-02-SUMMARY.md`
</output>

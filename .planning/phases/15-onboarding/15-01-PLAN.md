---
phase: 15-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/016_onboarding.sql
  - src/types/database.ts
  - src/hooks/use-onboarding.ts
  - src/components/onboarding/welcome-modal.tsx
  - src/components/onboarding/feature-tour.tsx
  - src/components/onboarding/tour-step.tsx
autonomous: true

must_haves:
  truths:
    - "New user sees welcome modal on first dashboard visit"
    - "Welcome modal offers choice to start tour or skip"
    - "Tour highlights Signals sidebar and Email generation"
    - "Tour step tooltip positions correctly relative to target"
    - "User can navigate forward/back through tour steps"
    - "Skipping or completing tour persists to database"
  artifacts:
    - path: "supabase/migrations/016_onboarding.sql"
      provides: "onboarding_completed_at column on profiles table"
      contains: "onboarding_completed_at"
    - path: "src/hooks/use-onboarding.ts"
      provides: "Onboarding state management hook"
      exports: ["useOnboarding"]
    - path: "src/components/onboarding/welcome-modal.tsx"
      provides: "Welcome modal with Motion animations"
      exports: ["WelcomeModal"]
    - path: "src/components/onboarding/feature-tour.tsx"
      provides: "Feature tour orchestration component"
      exports: ["FeatureTour"]
    - path: "src/components/onboarding/tour-step.tsx"
      provides: "Individual tour step with spotlight"
      exports: ["TourStep"]
  key_links:
    - from: "src/hooks/use-onboarding.ts"
      to: "profiles table"
      via: "supabase client"
      pattern: "supabase.*profiles.*onboarding_completed_at"
    - from: "src/components/onboarding/feature-tour.tsx"
      to: "src/components/onboarding/tour-step.tsx"
      via: "import"
      pattern: "import.*TourStep"
    - from: "src/components/onboarding/welcome-modal.tsx"
      to: "motion/react"
      via: "AnimatePresence"
      pattern: "AnimatePresence"
---

<objective>
Build welcome modal and feature tour components for new user onboarding.

Purpose: ONBR-01 and ONBR-02 - New users see a welcome screen after signup and get a guided tour of key features (Signals, Email Generation).

Output: Database migration for onboarding state, useOnboarding hook, WelcomeModal component, FeatureTour component with spotlight highlighting.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-onboarding/15-RESEARCH.md

# Existing patterns to follow
@src/components/ui/motion.tsx
@src/components/ui/button.tsx
@src/lib/supabase/client.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for onboarding state</name>
  <files>
    supabase/migrations/016_onboarding.sql
    src/types/database.ts
  </files>
  <action>
Create migration 016_onboarding.sql that adds `onboarding_completed_at` column to profiles table:

```sql
-- Add onboarding tracking column
ALTER TABLE public.profiles
ADD COLUMN IF NOT EXISTS onboarding_completed_at TIMESTAMPTZ DEFAULT NULL;

-- Add comment for documentation
COMMENT ON COLUMN public.profiles.onboarding_completed_at IS 'Timestamp when user completed onboarding flow, NULL means not completed';
```

Update src/types/database.ts to add `onboarding_completed_at: string | null` to the profiles table Row, Insert, and Update types. Add it after the existing subscription fields in each section.
  </action>
  <verify>
- File exists at supabase/migrations/016_onboarding.sql
- grep confirms `onboarding_completed_at` appears in src/types/database.ts
- `npx tsc --noEmit` passes with no type errors
  </verify>
  <done>
Migration file ready for deployment, TypeScript types updated with onboarding_completed_at field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build useOnboarding hook and WelcomeModal</name>
  <files>
    src/hooks/use-onboarding.ts
    src/components/onboarding/welcome-modal.tsx
  </files>
  <action>
**Create src/hooks/use-onboarding.ts:**

Hook with this interface:
```typescript
interface OnboardingState {
  phase: 'idle' | 'welcome' | 'tour' | 'wizard' | 'complete';
  tourStep: number;
  hasCompletedOnboarding: boolean;
  isLoading: boolean;
}

interface OnboardingActions {
  startOnboarding: () => void;
  startTour: () => void;
  nextTourStep: () => void;
  prevTourStep: () => void;
  startWizard: () => void;
  completeOnboarding: () => Promise<void>;
  skip: () => Promise<void>;
  resetOnboarding: () => Promise<void>;
}
```

Implementation requirements:
- On mount, check if user exists and fetch `onboarding_completed_at` from profiles
- Default `hasCompletedOnboarding` to true to avoid flash (only show onboarding if explicitly null)
- `completeOnboarding` and `skip` both update profiles table with current timestamp
- `resetOnboarding` sets column to null (for "restart tour" feature in settings)
- Use optimistic updates for immediate UI response

**Create src/components/onboarding/welcome-modal.tsx:**

Full-screen modal with backdrop blur using AnimatePresence pattern from motion.tsx research.

Props:
```typescript
interface WelcomeModalProps {
  isOpen: boolean;
  userName?: string;
  onStartTour: () => void;
  onSkip: () => void;
}
```

Design requirements:
- Backdrop with `bg-black/60 backdrop-blur-sm`
- Modal with scale/opacity animation (initial scale 0.9, animate to 1)
- Sparkles icon in gradient container (orange accent color)
- "Welcome to Axidex" title with optional userName
- Brief description: "You're all set to start detecting buying signals and generating personalized outreach. Let us show you around in 60 seconds."
- Two buttons: "Start Quick Tour" (primary), "Skip for now" (ghost)
- Close X button in top right
- Use existing Button component from @/components/ui/button
- Use easeOutExpo easing from motion.tsx patterns: [0.16, 1, 0.3, 1]
  </action>
  <verify>
- Files exist at both paths
- `npx tsc --noEmit` passes
- Exports are correct: `useOnboarding`, `WelcomeModal`
  </verify>
  <done>
useOnboarding hook manages onboarding state machine and database persistence. WelcomeModal displays animated welcome with tour/skip options.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build FeatureTour with spotlight steps</name>
  <files>
    src/components/onboarding/tour-step.tsx
    src/components/onboarding/feature-tour.tsx
  </files>
  <action>
**Create src/components/onboarding/tour-step.tsx:**

Spotlight highlighting component that:
1. Uses `getBoundingClientRect()` to position highlight around target element
2. Creates dark overlay with spotlight cutout using box-shadow technique (not clip-path for simplicity)
3. Positions tooltip relative to target with `position` prop (top/bottom/left/right)
4. Updates position on window resize/scroll via event listeners
5. Scrolls target element into view with `scrollIntoView({ behavior: 'smooth', block: 'center' })`

Props:
```typescript
interface TourStepProps {
  targetId: string;
  title: string;
  content: string;
  position?: 'top' | 'bottom' | 'left' | 'right';
  step: number;
  totalSteps: number;
  onNext: () => void;
  onPrev: () => void;
  onSkip: () => void;
}
```

Design requirements:
- z-50 for overlay, z-60 for tooltip
- Spotlight padding of 8px around target
- Tooltip with rounded-xl, max-w-sm, shadow-xl
- Progress indicator: "Step X of Y"
- Navigation: Back (disabled on step 1), Next (shows "Finish" on last step)
- Skip button (X icon)
- Use Motion for tooltip enter/exit animation
- Handle case where target element not found (skip step gracefully)

**Create src/components/onboarding/feature-tour.tsx:**

Orchestrator component that renders TourStep for current step.

Props:
```typescript
interface FeatureTourProps {
  isActive: boolean;
  currentStep: number;
  onNext: () => void;
  onPrev: () => void;
  onSkip: () => void;
  onComplete: () => void;
}
```

Tour steps configuration (3 steps, under 5 as research recommends):
1. **Signals Page** - targetId: "nav-signals" (sidebar link), title: "Your Signal Feed", content: "See all detected buying signals here. Filter by type, priority, or company to focus on what matters."
2. **Run Scraper** - targetId: "btn-run-scraper" (will add ID to dashboard), title: "Detect New Signals", content: "Click to scan for fresh buying signals from job boards, news, and LinkedIn."
3. **Email Generation** - targetId: "nav-emails" (sidebar link), title: "AI Email Drafts", content: "Generate personalized outreach emails for any signal with one click."

When step === totalSteps and user clicks Next, call onComplete.
  </action>
  <verify>
- Files exist at both paths
- `npx tsc --noEmit` passes
- Exports: `TourStep`, `FeatureTour`
- Tour has exactly 3 steps defined
  </verify>
  <done>
TourStep provides spotlight highlighting with tooltip. FeatureTour orchestrates 3-step tour: Signals, Scraper, Emails.
  </done>
</task>

</tasks>

<verification>
1. All 5 new files exist:
   - supabase/migrations/016_onboarding.sql
   - src/types/database.ts (updated)
   - src/hooks/use-onboarding.ts
   - src/components/onboarding/welcome-modal.tsx
   - src/components/onboarding/feature-tour.tsx
   - src/components/onboarding/tour-step.tsx

2. TypeScript compiles without errors: `npx tsc --noEmit`

3. Exports are correct:
   - useOnboarding from hooks
   - WelcomeModal, FeatureTour, TourStep from components
</verification>

<success_criteria>
- [ ] Migration adds onboarding_completed_at to profiles
- [ ] database.ts types include onboarding_completed_at
- [ ] useOnboarding hook manages phase state machine
- [ ] WelcomeModal animates in/out with Motion
- [ ] TourStep highlights target element with spotlight
- [ ] FeatureTour defines 3 tour steps (Signals, Scraper, Emails)
- [ ] All TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/15-onboarding/15-01-SUMMARY.md`
</output>

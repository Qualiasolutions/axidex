---
phase: 14-billing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/015_billing.sql
  - src/types/index.ts
  - src/lib/stripe.ts
  - src/app/api/billing/checkout/route.ts
  - src/app/pricing/page.tsx
  - src/app/api/webhooks/stripe/route.ts
autonomous: true
user_setup:
  - service: stripe
    why: "Payment processing for subscriptions"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Signing secret"
    dashboard_config:
      - task: "Create two products: Pro ($29/mo) and Enterprise ($99/mo)"
        location: "Stripe Dashboard -> Products"
      - task: "Create webhook endpoint pointing to /api/webhooks/stripe"
        location: "Stripe Dashboard -> Developers -> Webhooks"

must_haves:
  truths:
    - "User can view pricing tiers"
    - "User can initiate Stripe checkout for subscription"
    - "Webhook updates user subscription status in database"
  artifacts:
    - path: "supabase/migrations/015_billing.sql"
      provides: "Subscription schema with RLS"
      contains: "subscription_status"
    - path: "src/lib/stripe.ts"
      provides: "Stripe client initialization"
      exports: ["stripe"]
    - path: "src/app/api/billing/checkout/route.ts"
      provides: "Checkout session creation"
      exports: ["POST"]
    - path: "src/app/api/webhooks/stripe/route.ts"
      provides: "Stripe webhook handler"
      exports: ["POST"]
    - path: "src/app/pricing/page.tsx"
      provides: "Pricing page UI"
  key_links:
    - from: "src/app/pricing/page.tsx"
      to: "/api/billing/checkout"
      via: "fetch POST"
      pattern: "fetch.*api/billing/checkout"
    - from: "src/app/api/webhooks/stripe/route.ts"
      to: "supabase.profiles"
      via: "subscription status update"
      pattern: "subscription_status|subscription_tier"
---

<objective>
Implement Stripe checkout flow for subscription billing.

Purpose: Allow users to subscribe to paid tiers (Pro/Enterprise) via Stripe checkout, with webhook handling to sync subscription status.
Output: Database schema, Stripe client, checkout API, webhook handler, and pricing page.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/types/index.ts
@src/app/dashboard/settings/page.tsx
@supabase/migrations/001_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing database schema</name>
  <files>
    supabase/migrations/015_billing.sql
    src/types/index.ts
  </files>
  <action>
Create `supabase/migrations/015_billing.sql` with:

1. Add columns to profiles table:
   - `subscription_status` TEXT DEFAULT 'free' CHECK (subscription_status IN ('free', 'active', 'past_due', 'canceled'))
   - `subscription_tier` TEXT DEFAULT 'free' CHECK (subscription_tier IN ('free', 'pro', 'enterprise'))
   - `stripe_customer_id` TEXT UNIQUE
   - `stripe_subscription_id` TEXT
   - `subscription_period_end` TIMESTAMPTZ

2. Create subscriptions table for history:
   ```sql
   CREATE TABLE subscriptions (
     id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
     user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
     stripe_subscription_id TEXT NOT NULL,
     stripe_customer_id TEXT NOT NULL,
     status TEXT NOT NULL,
     tier TEXT NOT NULL,
     current_period_start TIMESTAMPTZ NOT NULL,
     current_period_end TIMESTAMPTZ NOT NULL,
     cancel_at_period_end BOOLEAN DEFAULT false,
     created_at TIMESTAMPTZ DEFAULT now(),
     updated_at TIMESTAMPTZ DEFAULT now()
   );
   ```

3. Add RLS policies for subscriptions table:
   - SELECT: users can see own subscriptions
   - No INSERT/UPDATE/DELETE from client (service role only)

4. Add indexes:
   - `profiles_stripe_customer_id_idx` ON profiles(stripe_customer_id)
   - `subscriptions_user_id_idx` ON subscriptions(user_id)

Update `src/types/index.ts`:
- Add `SubscriptionStatus` type: 'free' | 'active' | 'past_due' | 'canceled'
- Add `SubscriptionTier` type: 'free' | 'pro' | 'enterprise'
- Add `Subscription` interface with all fields
- Update `User` interface to include subscription fields
  </action>
  <verify>
Run `npx supabase db diff` to validate migration syntax.
Check types compile: `npx tsc --noEmit`
  </verify>
  <done>
Migration file exists with subscription schema and RLS.
Types updated with Subscription interface and User subscription fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe client and checkout API</name>
  <files>
    src/lib/stripe.ts
    src/app/api/billing/checkout/route.ts
    src/app/pricing/page.tsx
  </files>
  <action>
1. Install Stripe SDK: `npm install stripe`

2. Create `src/lib/stripe.ts`:
```typescript
import Stripe from 'stripe';

if (!process.env.STRIPE_SECRET_KEY) {
  throw new Error('Missing STRIPE_SECRET_KEY');
}

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2024-12-18.acacia',
  typescript: true,
});

export const PLANS = {
  pro: {
    name: 'Pro',
    price: 29,
    priceId: process.env.STRIPE_PRO_PRICE_ID!,
    features: ['Unlimited signals', '5 automation rules', 'Email notifications', 'Slack integration'],
  },
  enterprise: {
    name: 'Enterprise',
    price: 99,
    priceId: process.env.STRIPE_ENTERPRISE_PRICE_ID!,
    features: ['Everything in Pro', 'Unlimited rules', 'CRM integrations', 'Priority support', 'Custom sources'],
  },
} as const;
```

3. Create `src/app/api/billing/checkout/route.ts`:
- POST handler accepting { priceId, tier }
- Get authenticated user from Supabase
- Create or retrieve Stripe customer (using stripe_customer_id or email)
- Create checkout session with:
  - mode: 'subscription'
  - success_url: `/dashboard?checkout=success`
  - cancel_url: `/pricing?checkout=canceled`
  - customer: stripeCustomerId
  - metadata: { userId, tier }
- Update profiles.stripe_customer_id if new customer created
- Return { url: session.url }

4. Create `src/app/pricing/page.tsx`:
- Server component that redirects if already subscribed (pro/enterprise)
- Display pricing cards for Free, Pro ($29/mo), Enterprise ($99/mo)
- Feature lists per tier
- "Get Started" buttons that POST to /api/billing/checkout
- Match existing design system (warm orange accent, premium minimalist)
- Use Motion for entrance animations
  </action>
  <verify>
`npm run build` passes.
Visit /pricing page - shows three tiers.
Click upgrade button (will fail without Stripe config, but API route should exist).
  </verify>
  <done>
Stripe client initialized with PLANS config.
Checkout API creates Stripe checkout sessions.
Pricing page displays tiers with upgrade buttons.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Stripe webhook handler</name>
  <files>
    src/app/api/webhooks/stripe/route.ts
  </files>
  <action>
Create `src/app/api/webhooks/stripe/route.ts`:

1. Export config to disable body parsing:
```typescript
export const runtime = 'nodejs';
// Disable Next.js body parsing for raw body access
```

2. POST handler:
- Read raw body with `await request.text()`
- Verify webhook signature using `stripe.webhooks.constructEvent()`
- Handle events:
  - `checkout.session.completed`: Create subscription record, update profile
  - `customer.subscription.updated`: Update subscription status/tier
  - `customer.subscription.deleted`: Set status to 'canceled'
  - `invoice.payment_failed`: Set status to 'past_due'
  - `invoice.paid`: Set status to 'active' (handles past_due recovery)

3. For each event, use Supabase service role client to update:
- profiles: subscription_status, subscription_tier, subscription_period_end
- subscriptions: insert/update history record

4. Return 200 OK for processed events, 400 for signature errors.

5. Add error logging with console.error for debugging.

Important: Use `process.env.STRIPE_WEBHOOK_SECRET` for verification.
Important: Create Supabase client with service role key for webhook operations.
  </action>
  <verify>
`npm run build` passes.
Route exists at /api/webhooks/stripe.
Test with Stripe CLI: `stripe listen --forward-to localhost:3000/api/webhooks/stripe`
  </verify>
  <done>
Webhook handler processes subscription events.
Profile subscription_status updates on checkout completion.
Subscription history tracked in subscriptions table.
  </done>
</task>

</tasks>

<verification>
1. Schema migration is syntactically valid
2. Types compile without errors: `npx tsc --noEmit`
3. Build passes: `npm run build`
4. Pricing page renders at /pricing
5. Checkout API returns URL (or appropriate error without Stripe config)
6. Webhook endpoint exists and responds
</verification>

<success_criteria>
- [ ] Migration 015_billing.sql creates subscription schema
- [ ] Stripe client exports `stripe` and `PLANS`
- [ ] POST /api/billing/checkout creates checkout session
- [ ] POST /api/webhooks/stripe processes subscription events
- [ ] /pricing page shows three tiers with upgrade buttons
- [ ] Types include Subscription and updated User interfaces
</success_criteria>

<output>
After completion, create `.planning/phases/14-billing/14-01-SUMMARY.md`
</output>

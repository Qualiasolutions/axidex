---
phase: 11-performance
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/app/dashboard/rules/page.tsx
  - src/app/dashboard/signals/page.tsx
  - src/components/layout/sidebar.tsx
  - src/components/signals/signal-card.tsx
  - src/components/rules/rule-card.tsx
  - src/components/emails/email-card.tsx
  - src/components/accounts/account-card.tsx
autonomous: true

must_haves:
  truths:
    - "User actions update UI immediately before API response"
    - "Failed mutations revert to original state"
    - "Links prefetch data on hover"
    - "Navigating to prefetched pages loads instantly"
  artifacts:
    - path: "src/app/dashboard/rules/page.tsx"
      provides: "Optimistic toggle and delete for rules"
      contains: "mutate.*optimisticData"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Prefetch on hover for navigation links"
      contains: "onMouseEnter|prefetch"
  key_links:
    - from: "src/app/dashboard/rules/page.tsx"
      to: "src/hooks/use-rules.ts"
      via: "mutate function from SWR"
      pattern: "mutate\\("
    - from: "src/components/layout/sidebar.tsx"
      to: "next/link"
      via: "Link prefetch behavior"
      pattern: "prefetch"
---

<objective>
Add optimistic UI updates for user actions and prefetching for instant navigation.

Purpose: Make the UI feel instant - actions update immediately, navigation feels snappy.

Output: Optimistic mutations for rules/signals, prefetch hooks for sidebar links and cards.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-performance/11-01-SUMMARY.md

@src/app/dashboard/rules/page.tsx
@src/hooks/use-rules.ts
@src/components/layout/sidebar.tsx
@src/components/signals/signal-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add optimistic updates to rules page</name>
  <files>src/app/dashboard/rules/page.tsx</files>
  <action>
Update rules page to use SWR's optimistic update pattern:

1. **handleToggleRule (enable/disable rule)**:
   - Before API call: Update local cache optimistically
   - Use mutate() with optimisticData that toggles is_active
   - On API success: Let revalidation confirm
   - On API error: Revert by calling mutate() again with rollback data

   Pattern:
   ```typescript
   const handleToggleRule = async (rule: AutomationRule, isActive: boolean) => {
     // Store current state for rollback
     const previousRules = rules;

     // Optimistic update
     mutate(
       {
         rules: rules.map(r => r.id === rule.id ? { ...r, is_active: isActive } : r),
         count
       },
       { revalidate: false }
     );

     try {
       await fetch(`/api/rules/${rule.id}`, {
         method: "PATCH",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify({ is_active: isActive }),
       });
       // Revalidate to confirm
       mutate();
     } catch {
       // Rollback on error
       mutate({ rules: previousRules, count }, { revalidate: false });
     }
   };
   ```

2. **handleDeleteRule**:
   - Optimistically remove rule from list immediately
   - Call API
   - Revert if API fails

3. **handleDuplicateRule**:
   - Call API first (need the new rule's ID)
   - Add to cache when API responds
   - This one can't be fully optimistic since we need server-generated ID

4. **handleCreateFromTemplate**:
   - Similar to duplicate - call API, then add to cache
  </action>
  <verify>
- Toggle a rule: UI updates immediately, no visible loading
- Delete a rule: Rule disappears immediately
- Network tab shows API calls happening in background
- If you throttle network, UI still responds instantly
  </verify>
  <done>Rules page has optimistic updates for toggle and delete</done>
</task>

<task type="auto">
  <name>Task 2: Add optimistic updates for signal interactions</name>
  <files>src/app/dashboard/signals/page.tsx, src/components/signals/signal-card.tsx</files>
  <action>
Add optimistic updates for signal interactions:

1. **In signals/page.tsx - mark as read**:
   If there's a "mark as read" or status change functionality:
   - Optimistically update signal status in cache
   - Call API in background
   - Revert on failure

   Note: Current signals page is read-only. If no write operations exist, skip this.

2. **In signal-card.tsx**:
   - Check if there are any interactive elements (star, bookmark, mark read)
   - If yes, implement optimistic pattern using parent's mutate
   - If no write operations, document this as "read-only - no optimistic updates needed"

3. **Review other card components**:
   - email-card.tsx: Check for "mark as sent" or similar
   - account-card.tsx: Likely read-only
   - If any have mutations, add optimistic updates

For any mutation found, the pattern is:
1. Update local state immediately
2. Fire API request
3. Revalidate on success, rollback on failure
  </action>
  <verify>
- If mutations exist: They update UI immediately
- If read-only: Document in summary that signals/emails/accounts are read-only
  </verify>
  <done>All mutable UI elements have optimistic updates</done>
</task>

<task type="auto">
  <name>Task 3: Add prefetch on hover to navigation and cards</name>
  <files>src/components/layout/sidebar.tsx, src/components/signals/signal-card.tsx, src/components/emails/email-card.tsx, src/components/accounts/account-card.tsx, src/components/rules/rule-card.tsx</files>
  <action>
Add prefetching to make navigation feel instant:

1. **Sidebar navigation (sidebar.tsx)**:
   Next.js Link already prefetches on viewport entry. Enhance by:
   - Ensure all nav Links have `prefetch={true}` (default, but be explicit)
   - Add `onMouseEnter` to trigger SWR prefetch for the target page's data:

   ```typescript
   import { preload } from 'swr';
   import { fetcher } from '@/lib/swr';

   const handlePrefetch = (href: string) => {
     // Prefetch data based on route
     if (href === '/dashboard/signals') {
       preload('/api/signals?limit=20', fetcher);
     } else if (href === '/dashboard/emails') {
       preload('/api/emails?limit=20', fetcher);
     }
     // etc.
   };

   // In Link wrapper:
   <Link href={href} onMouseEnter={() => handlePrefetch(href)}>
   ```

2. **Signal cards (signal-card.tsx)**:
   - The card links to `/dashboard/signals/[id]`
   - On hover, prefetch the signal detail data
   - Use `onMouseEnter` to call `preload(\`/api/signals/${id}\`, fetcher)`

3. **Email cards (email-card.tsx)**:
   - Similar pattern for email detail prefetch

4. **Account cards (account-card.tsx)**:
   - Prefetch account detail on hover

5. **Rule cards (rule-card.tsx)**:
   - Prefetch rule detail on hover (links to /dashboard/rules/[id])

Prefetch implementation:
- Import `preload` from 'swr'
- Import `fetcher` from '@/lib/swr'
- Add onMouseEnter handler to Link or wrapper div
- Call preload with the API endpoint the detail page will use
  </action>
  <verify>
- Hover over sidebar link, then click - page loads instantly
- Hover over signal card, then click - detail loads instantly
- Check Network tab: requests fire on hover before click
- DevTools SWR DevTools (if installed) shows prefetched cache entries
  </verify>
  <done>All navigation and cards prefetch data on hover</done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. TypeScript passes: `npx tsc --noEmit`
3. Test optimistic updates:
   - Toggle rule on/off: Immediate visual feedback
   - Delete rule: Disappears immediately
4. Test prefetching:
   - Hover sidebar link, click: Instant page load
   - Hover card, click: Instant detail load
   - Network tab shows requests on hover
</verification>

<success_criteria>
- Rule toggles/deletes feel instant (no loading states visible)
- Navigation between pages feels snappy
- Network requests happen in background on hover
- Failed mutations gracefully revert to original state
</success_criteria>

<output>
After completion, create `.planning/phases/11-performance/11-02-SUMMARY.md`
</output>

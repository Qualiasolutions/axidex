---
phase: 06-production-deployment
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: []
autonomous: false

user_setup:
  - service: railway
    why: "Worker deployment"
    env_vars:
      - name: RAILWAY_TOKEN
        source: "Railway Dashboard -> Account Settings -> Tokens -> Create Token"
      - name: SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key"
      - name: OPENAI_API_KEY
        source: "OpenAI Platform -> API Keys"
  - service: supabase
    why: "Edge Function deployment and webhook configuration"
    dashboard_config:
      - task: "Create database webhook for signals INSERT"
        location: "Supabase Dashboard -> Database -> Webhooks -> Create New"

must_haves:
  truths:
    - "Worker runs on Railway and processes signals on schedule"
    - "Edge Function deployed and responds to webhook calls"
    - "Database webhook triggers Edge Function on signals INSERT"
    - "RLS prevents users from accessing other users' data"
  artifacts:
    - path: "worker/src/main.py"
      provides: "Signal processing worker"
      contains: "schedule, scrapers"
    - path: "supabase/functions/check-notification/index.ts"
      provides: "Notification evaluation function"
      contains: "serve, WebhookPayload"
  key_links:
    - from: "Supabase webhook"
      to: "check-notification Edge Function"
      via: "HTTP POST on signals INSERT"
      pattern: "database trigger -> edge function URL"
    - from: "check-notification Edge Function"
      to: "/api/send-notification"
      via: "fetch call to Next.js API route"
      pattern: "fetch.*api/send-notification"
---

<objective>
Deploy worker to Railway, deploy Edge Function to Supabase, configure database webhook, and verify RLS.

Purpose: Enables automated signal processing and notification delivery in production.
Output: Running worker on Railway, active Edge Function, configured webhook, verified RLS.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-production-deployment/06-01-SUMMARY.md
@worker/railway.toml
@worker/Dockerfile
@supabase/functions/check-notification/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy worker to Railway</name>
  <files>worker/</files>
  <action>
1. Check if Railway CLI is installed: `railway --version`
   - If not installed: `npm install -g @railway/cli`

2. Login to Railway: `railway login`
   - Opens browser for OAuth flow

3. Navigate to worker directory and initialize Railway project:
```bash
cd worker
railway init
# When prompted, create new project named "axidex-worker"
```

4. Set environment variables:
```bash
railway variables set SUPABASE_URL="<SUPABASE_URL>"
railway variables set SUPABASE_SERVICE_ROLE_KEY="<SERVICE_ROLE_KEY>"
railway variables set OPENAI_API_KEY="<OPENAI_KEY>"
```

5. Deploy:
```bash
railway up
```
   - This builds the Dockerfile and deploys

6. Verify deployment:
```bash
railway logs
```
   - Should show "Worker started" or similar startup message

Do NOT run `railway link` on existing projects - use `railway init` for new deployment.
  </action>
  <verify>
Run: `railway status` - should show service as "Active"
Run: `railway logs --tail 20` - should show recent activity without errors
  </verify>
  <done>Worker deployed to Railway, showing Active status and healthy logs.</done>
</task>

<task type="auto">
  <name>Task 2: Deploy check-notification Edge Function</name>
  <files>supabase/functions/check-notification/index.ts</files>
  <action>
1. Ensure Supabase CLI is linked (from Plan 01)

2. Deploy the Edge Function:
```bash
supabase functions deploy check-notification --no-verify-jwt
```
   - --no-verify-jwt allows webhook calls without user JWT

3. Set function secrets (from root directory):
```bash
supabase secrets set SUPABASE_URL="<SUPABASE_URL>"
supabase secrets set SUPABASE_SERVICE_ROLE_KEY="<SERVICE_ROLE_KEY>"
supabase secrets set APP_URL="https://axidex.vercel.app"
```

4. Test function is deployed:
```bash
supabase functions list
```
   - Should show "check-notification" in the list

The Edge Function URL will be:
https://<PROJECT_REF>.supabase.co/functions/v1/check-notification
  </action>
  <verify>
Run: `supabase functions list` - should show check-notification as deployed.
Check Supabase Dashboard -> Edge Functions -> check-notification shows "Active" status.
  </verify>
  <done>Edge Function deployed and active in Supabase.</done>
</task>

<task type="auto">
  <name>Task 3: Configure database webhook for signals INSERT</name>
  <files></files>
  <action>
The Supabase CLI does not support webhook creation - this must be done via Dashboard.

However, we can verify the configuration by checking if the webhook would work:

1. Get the Edge Function URL:
```bash
supabase functions list
# Copy the URL for check-notification
```

2. Test the Edge Function manually with a mock payload:
```bash
curl -X POST "https://<PROJECT_REF>.supabase.co/functions/v1/check-notification" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "INSERT",
    "table": "signals",
    "schema": "public",
    "record": {
      "id": "test-123",
      "user_id": "test-user",
      "company_name": "Test Co",
      "signal_type": "hiring",
      "title": "Test Signal",
      "summary": "Test summary",
      "priority": "high"
    },
    "old_record": null
  }'
```
   - Should return JSON response (may be "User not found" which is expected)

Output the webhook configuration instructions for manual setup in checkpoint.
  </action>
  <verify>
The curl test should return a valid JSON response (not a 500 error).
  </verify>
  <done>Edge Function responds to webhook-style payloads; ready for webhook configuration.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Worker deployed to Railway, Edge Function deployed, webhook ready for configuration</what-built>
  <how-to-verify>
**1. Verify Railway Worker:**
   - Open Railway Dashboard -> axidex-worker project
   - Check service status is "Active"
   - Review logs for any errors

**2. Verify Edge Function:**
   - Open Supabase Dashboard -> Edge Functions
   - Verify check-notification is listed and Active

**3. Configure Database Webhook (MANUAL STEP):**
   - Open Supabase Dashboard -> Database -> Webhooks
   - Click "Create a new webhook"
   - Configure:
     - Name: `notify-on-signal-insert`
     - Table: `signals`
     - Events: `INSERT` only
     - Type: `Supabase Edge Functions`
     - Edge Function: `check-notification`
     - HTTP Headers: (none needed - function uses --no-verify-jwt)
   - Click "Create webhook"

**4. Test RLS (CRITICAL):**
   - Open Supabase Dashboard -> SQL Editor
   - Run this query to verify RLS:
   ```sql
   -- This should return TRUE (RLS is enabled)
   SELECT relrowsecurity FROM pg_class
   WHERE relname = 'signals';

   -- Test that anon user cannot see signals
   SET ROLE anon;
   SELECT * FROM signals LIMIT 1;
   -- Should return empty or permission denied
   RESET ROLE;
   ```

**5. End-to-end test (optional but recommended):**
   - Log into https://axidex.vercel.app
   - Create a test signal via API or wait for worker to scrape
   - Check if notification email is triggered (if preferences allow)
  </how-to-verify>
  <resume-signal>Type "approved" if worker, Edge Function, webhook, and RLS are all working. Or describe issues.</resume-signal>
</task>

</tasks>

<verification>
- Railway Dashboard shows worker as "Active"
- Supabase Edge Functions shows check-notification deployed
- Database webhook configured for signals INSERT
- RLS test query confirms policies are enforced
</verification>

<success_criteria>
- DEPL-02: Worker deployed to Railway with correct environment variables
- DEPL-04: Database webhook configured for signals INSERT
- DEPL-05: check-notification Edge Function deployed and active
- DEPL-06: RLS verified - users cannot access other users' data
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-deployment/06-02-SUMMARY.md`
</output>

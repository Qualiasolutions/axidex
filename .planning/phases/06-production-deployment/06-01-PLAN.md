---
phase: 06-production-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

user_setup:
  - service: supabase
    why: "Database migrations and project linking"
    env_vars:
      - name: SUPABASE_ACCESS_TOKEN
        source: "Supabase Dashboard -> Account Settings -> Access Tokens -> Generate New Token"
    dashboard_config:
      - task: "Enable email auth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"
      - task: "Set Site URL to https://axidex.vercel.app"
        location: "Supabase Dashboard -> Authentication -> URL Configuration"
  - service: vercel
    why: "Environment variable configuration"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys"
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key"

must_haves:
  truths:
    - "All 9 database migrations applied to production Supabase"
    - "Vercel deployment has ANTHROPIC_API_KEY, RESEND_API_KEY, SUPABASE_SERVICE_ROLE_KEY"
    - "Supabase Auth configured with email provider and correct site URL"
  artifacts:
    - path: "supabase/migrations/001_schema.sql through 009_stats_optimization.sql"
      provides: "Database schema in production"
      contains: "All tables, indexes, RLS policies"
  key_links:
    - from: "Vercel deployment"
      to: "Supabase production database"
      via: "SUPABASE_SERVICE_ROLE_KEY env var"
      pattern: "Environment variables set in Vercel dashboard"
---

<objective>
Apply database migrations to production Supabase and configure Vercel environment variables.

Purpose: Establishes the data foundation and API credentials needed for production.
Output: Production database with all tables, RLS policies; Vercel with required API keys.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/001_schema.sql
@supabase/migrations/002_rls.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply Supabase migrations to production</name>
  <files>supabase/migrations/*.sql</files>
  <action>
1. Check if Supabase CLI is installed: `supabase --version`
2. Link to production project: `supabase link --project-ref <PROJECT_REF>`
   - Get PROJECT_REF from Supabase Dashboard URL: https://supabase.com/dashboard/project/<PROJECT_REF>
   - If auth error, run `supabase login` first
3. Push all migrations: `supabase db push`
   - This applies migrations 001-009 to production
4. Verify migrations applied: `supabase db remote commit`
   - Should show "No new migrations to commit"

Do NOT use `supabase db reset` - that wipes data. Use `db push` only.
  </action>
  <verify>
Run: `supabase db remote commit` - should report no pending migrations.
Check Supabase Dashboard -> Database -> Tables shows: signals, profiles, generated_emails tables.
  </verify>
  <done>All 9 migrations applied; tables visible in Supabase Dashboard.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vercel environment variables</name>
  <files></files>
  <action>
1. Check if Vercel CLI is installed: `vercel --version`
2. Link project if needed: `vercel link` (select existing "axidex" project)
3. Add production environment variables:

```bash
vercel env add ANTHROPIC_API_KEY production
# Enter the API key when prompted

vercel env add RESEND_API_KEY production
# Enter the API key when prompted

vercel env add SUPABASE_SERVICE_ROLE_KEY production
# Enter the service role key when prompted
```

4. Trigger a new deployment to pick up env vars:
```bash
vercel --prod
```

Do NOT add env vars with `--force` flag - it overwrites without confirmation.
  </action>
  <verify>
Run: `vercel env ls` - should show ANTHROPIC_API_KEY, RESEND_API_KEY, SUPABASE_SERVICE_ROLE_KEY in production.
  </verify>
  <done>Three environment variables configured in Vercel production.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Database migrations applied and Vercel environment configured</what-built>
  <how-to-verify>
1. Open Supabase Dashboard -> Database -> Tables
   - Verify tables exist: signals, profiles, generated_emails, notification_preferences
   - Check RLS is enabled on all tables

2. Open Supabase Dashboard -> Authentication -> Providers
   - Verify Email provider is enabled

3. Open Supabase Dashboard -> Authentication -> URL Configuration
   - Verify Site URL is set to https://axidex.vercel.app

4. Open https://axidex.vercel.app
   - App should load without errors
   - Check browser console for any API errors
  </how-to-verify>
  <resume-signal>Type "approved" if database and Vercel are configured correctly, or describe issues.</resume-signal>
</task>

</tasks>

<verification>
- `supabase db remote commit` returns no pending migrations
- `vercel env ls` shows all three production env vars
- Supabase Dashboard shows all tables with RLS enabled
- https://axidex.vercel.app loads without errors
</verification>

<success_criteria>
- DEPL-01: All 9 migrations applied to production Supabase
- DEPL-03: Vercel has ANTHROPIC_API_KEY, RESEND_API_KEY, SUPABASE_SERVICE_ROLE_KEY
- Supabase Auth configured for email provider
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-deployment/06-01-SUMMARY.md`
</output>

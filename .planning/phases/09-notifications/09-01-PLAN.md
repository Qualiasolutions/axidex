---
phase: 09-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/REQUIREMENTS.md
  - .planning/STATE.md
autonomous: false

user_setup:
  - service: resend
    why: "Email delivery for notifications"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify domain (optional) or use onboarding@resend.dev for testing"
        location: "Resend Dashboard -> Domains"
  - service: supabase
    why: "Database webhook to trigger Edge Function on signals INSERT"
    dashboard_config:
      - task: "Create database webhook for signals INSERT -> check-notification Edge Function"
        location: "Supabase Dashboard -> Database -> Webhooks"

must_haves:
  truths:
    - "User can access notification preferences in settings page"
    - "User can toggle email notifications on/off"
    - "User can set priority threshold for notifications"
    - "User receives email within 5 minutes of matching signal insertion"
  artifacts:
    - path: "src/app/dashboard/settings/page.tsx"
      provides: "Notification preferences UI"
      min_lines: 200
    - path: "supabase/functions/check-notification/index.ts"
      provides: "Webhook handler for signals INSERT"
      min_lines: 150
    - path: "src/app/api/send-notification/route.ts"
      provides: "Email sending via Resend"
      min_lines: 80
    - path: "src/components/emails/signal-alert.tsx"
      provides: "Email template for signal alerts"
      min_lines: 50
  key_links:
    - from: "supabase database webhook"
      to: "check-notification Edge Function"
      via: "HTTP POST on signals INSERT"
      pattern: "signals INSERT trigger"
    - from: "check-notification Edge Function"
      to: "/api/send-notification"
      via: "fetch call"
      pattern: "fetch.*api/send-notification"
    - from: "/api/send-notification"
      to: "Resend API"
      via: "Resend SDK"
      pattern: "resend\\.emails\\.send"
---

<objective>
Verify notification system end-to-end

Purpose: The notification infrastructure is already built (settings UI, Edge Function, API route, email template). This plan verifies all components work together and marks requirements complete.

Output: NOTF-01 and NOTF-02 marked complete, phase 9 closed
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Existing infrastructure (verification only, do not modify)
@src/app/dashboard/settings/page.tsx
@supabase/functions/check-notification/index.ts
@src/app/api/send-notification/route.ts
@src/components/emails/signal-alert.tsx
@supabase/migrations/004_notification_prefs.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify existing code matches requirements</name>
  <files>
    src/app/dashboard/settings/page.tsx
    supabase/functions/check-notification/index.ts
    src/app/api/send-notification/route.ts
    src/components/emails/signal-alert.tsx
    supabase/migrations/004_notification_prefs.sql
  </files>
  <action>
Read and verify each file implements the required functionality:

1. Settings page (settings/page.tsx):
   - Email toggle (on/off) exists
   - Priority threshold selector exists (high only / medium and high / all signals)
   - Signal type checkboxes exist
   - Saves to Supabase profiles.notification_preferences

2. Edge Function (check-notification/index.ts):
   - Triggered by webhook payload with INSERT type
   - Reads user notification preferences from profiles table
   - Checks email_enabled, signal_types, priority_threshold
   - Calls /api/send-notification if criteria match

3. Send Notification API (send-notification/route.ts):
   - Accepts POST with email, userName, signal payload
   - Uses Resend SDK to send email
   - Lazy-initializes Resend client (D017 decision)
   - Uses SignalAlertEmail template

4. Email Template (signal-alert.tsx):
   - React Email component
   - Shows signal details and priority badge
   - Links to dashboard and settings

5. Migration (004_notification_prefs.sql):
   - Adds notification_preferences JSONB column to profiles
   - Has GIN index for efficient queries

DO NOT modify any code. This is verification only.
  </action>
  <verify>
All files exist and contain expected functionality:
- Settings page has email toggle, priority selector, signal type checkboxes
- Edge Function has preference checking logic
- API route has Resend integration
- Email template renders signal data
- Migration adds JSONB column
  </verify>
  <done>
All 5 files verified as implementing NOTF-01 and NOTF-02 requirements correctly
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Add RESEND_API_KEY to Vercel</name>
  <action>
Add the Resend API key to Vercel environment variables.
  </action>
  <instructions>
1. Go to Resend Dashboard: https://resend.com/api-keys
2. Copy your API key (or create a new one)
3. Go to Vercel Dashboard -> axidex project -> Settings -> Environment Variables
4. Add: RESEND_API_KEY = [your api key]
5. Select: Production, Preview, Development
6. Click Save
7. Redeploy to pick up new env var (or wait for next push)
  </instructions>
  <resume-signal>Type "done" when RESEND_API_KEY is added to Vercel</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure Supabase database webhook</name>
  <action>
Create a database webhook that triggers the check-notification Edge Function on signals INSERT.
  </action>
  <instructions>
1. Go to Supabase Dashboard -> Database -> Webhooks
2. Click "Create a new webhook"
3. Configure:
   - Name: check-notification
   - Table: signals
   - Events: INSERT only
   - Type: Supabase Edge Function
   - Edge Function: check-notification
   - (If Edge Function not deployed, first run: supabase functions deploy check-notification)
4. Click "Create webhook"
5. Test by inserting a test signal (or wait for next worker run)
  </instructions>
  <resume-signal>Type "done" when webhook is configured</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: End-to-end verification</name>
  <what-built>Complete notification pipeline: Settings UI -> Database webhook -> Edge Function -> Send Notification API -> Resend email</what-built>
  <how-to-verify>
1. Visit https://axidex.vercel.app/dashboard/settings
2. Verify you can:
   - Toggle email notifications on/off
   - Select priority threshold (high only / medium and high / all signals)
   - Select/deselect signal types
   - Click "Save preferences" and see success message
3. Check Supabase profiles table for your user - notification_preferences should be populated
4. Insert a test high-priority signal:
   ```sql
   INSERT INTO signals (user_id, company_name, signal_type, title, summary, priority, source_url, raw_content)
   VALUES (
     '[your-user-id]',
     'Test Company',
     'hiring',
     'Test Hiring Signal',
     'This is a test notification',
     'high',
     'https://example.com',
     'Test content'
   );
   ```
5. Check your email inbox within 5 minutes for "New Signal: Test Company - Hiring"
6. If email received: notification system verified end-to-end
  </how-to-verify>
  <resume-signal>Type "approved" if email received, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 9 Notifications is complete when:
1. All existing code verified as correct
2. RESEND_API_KEY added to Vercel
3. Supabase database webhook configured
4. End-to-end test passes (signal INSERT -> email received)
</verification>

<success_criteria>
- Settings page allows configuring notification preferences
- Preferences persist to database
- Signal INSERT triggers webhook
- Edge Function evaluates preferences
- Matching signals result in email delivery
- Requirements NOTF-01 and NOTF-02 complete
</success_criteria>

<output>
After completion:
1. Mark NOTF-01 and NOTF-02 as complete in REQUIREMENTS.md
2. Update traceability table
3. Update STATE.md: Phase 9 complete, v1.1 milestone complete
4. Create `.planning/phases/09-notifications/09-01-SUMMARY.md`
</output>

---
phase: 04-automation-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/004_notification_prefs.sql
  - src/app/dashboard/settings/page.tsx
  - src/components/emails/signal-alert.tsx
  - src/app/api/send-notification/route.ts
  - supabase/functions/check-notification/index.ts
autonomous: true

user_setup:
  - service: resend
    why: "Transactional email delivery"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify sending domain (optional, can use onboarding@resend.dev for dev)"
        location: "Resend Dashboard -> Domains -> Add Domain"
  - service: supabase-webhook
    why: "Trigger notifications on signal insert"
    dashboard_config:
      - task: "Create database webhook for signals table INSERT"
        location: "Supabase Dashboard -> Database -> Webhooks -> Create Webhook"
      - task: "Point webhook to Edge Function URL with service role key header"
        location: "Webhook config -> URL: https://PROJECT.supabase.co/functions/v1/check-notification"

must_haves:
  truths:
    - "User can toggle email notifications on/off in settings"
    - "User can select which signal types trigger notifications"
    - "User can set priority threshold (high only, medium+, all)"
    - "High-priority signal insert triggers email to user"
    - "Email contains signal details and dashboard link"
  artifacts:
    - path: "supabase/migrations/004_notification_prefs.sql"
      provides: "notification_preferences JSONB column on profiles"
      contains: "notification_preferences"
    - path: "src/app/dashboard/settings/page.tsx"
      provides: "Settings UI for notification preferences"
      min_lines: 80
    - path: "src/components/emails/signal-alert.tsx"
      provides: "React Email template for signal alerts"
      min_lines: 30
    - path: "src/app/api/send-notification/route.ts"
      provides: "API route to send email via Resend"
      exports: ["POST"]
    - path: "supabase/functions/check-notification/index.ts"
      provides: "Edge Function to evaluate preferences and trigger email"
      min_lines: 50
  key_links:
    - from: "src/app/dashboard/settings/page.tsx"
      to: "profiles.notification_preferences"
      via: "supabase update"
      pattern: "update.*notification_preferences"
    - from: "supabase/functions/check-notification/index.ts"
      to: "src/app/api/send-notification/route.ts"
      via: "fetch POST"
      pattern: "fetch.*send-notification"
    - from: "src/app/api/send-notification/route.ts"
      to: "resend.emails.send"
      via: "Resend SDK"
      pattern: "resend\\.emails\\.send"
---

<objective>
Build complete notification system: user preferences UI, email templates, and event-driven email delivery.

Purpose: Allow users to receive instant email alerts when high-priority signals match their criteria. This is the key automation that makes Axidex valuable - users don't have to check the dashboard manually.

Output: Settings page for notification preferences, React Email template, Resend API integration, and Supabase Edge Function for event-driven triggers.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-automation-hardening/04-RESEARCH.md

# Existing dashboard structure
@src/app/dashboard/layout.tsx
@src/app/dashboard/page.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and Settings page UI</name>
  <files>
    supabase/migrations/004_notification_prefs.sql
    src/app/dashboard/settings/page.tsx
  </files>
  <action>
1. Create supabase/migrations/004_notification_prefs.sql:
   ```sql
   -- Add notification preferences to profiles
   ALTER TABLE profiles
   ADD COLUMN IF NOT EXISTS notification_preferences JSONB DEFAULT '{
     "email_enabled": true,
     "signal_types": ["hiring", "funding", "expansion", "partnership", "product_launch", "leadership_change"],
     "priority_threshold": "high"
   }'::jsonb;

   -- Index for querying preferences
   CREATE INDEX IF NOT EXISTS idx_profiles_notification_prefs
   ON profiles USING gin (notification_preferences);
   ```

2. Create src/app/dashboard/settings/page.tsx:
   - "use client" directive
   - Import { createClient } from "@/lib/supabase/client"
   - Import { Button } from "@/components/ui/button"
   - State: prefs object with email_enabled, signal_types[], priority_threshold
   - useEffect to load current preferences from profiles table
   - Sections:
     a) Email toggle (checkbox)
     b) Priority threshold (radio: "high", "medium", "low")
     c) Signal types (checkboxes for each type)
   - Save button that updates profiles.notification_preferences
   - Use toast/alert for save confirmation
   - Style with existing design system (white cards, orange accent, Tailwind)
   - Reference 04-RESEARCH.md Settings Page Component example

3. Add "Settings" link to sidebar in dashboard layout (if not already present):
   - Check src/app/dashboard/layout.tsx
   - Add navigation item for /dashboard/settings
  </action>
  <verify>
    npm run build && echo "Build passes with settings page"
  </verify>
  <done>Migration file exists, Settings page renders, save updates profiles table</done>
</task>

<task type="auto">
  <name>Task 2: Email template, API route, and Edge Function</name>
  <files>
    src/components/emails/signal-alert.tsx
    src/app/api/send-notification/route.ts
    supabase/functions/check-notification/index.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install resend @react-email/components
   ```

2. Create src/components/emails/signal-alert.tsx:
   - React Email template (see 04-RESEARCH.md Pattern 4)
   - Props: userName, companyName, signalType, signalTitle, dashboardUrl
   - Style: Clean, mobile-friendly, orange CTA button matching brand
   - Include unsubscribe hint (link to settings page)

3. Create src/app/api/send-notification/route.ts:
   - Import Resend and SignalAlertEmail
   - POST handler accepting { email, userName, signal }
   - Validate request has required fields
   - Use Resend to send email with react template
   - Return { success: true, id } or { error }
   - Add auth check: verify request comes from Edge Function (internal API key or service role)
   - Use env: RESEND_API_KEY, INTERNAL_API_KEY (optional, for auth)

4. Create supabase/functions/check-notification/index.ts:
   - Deno Edge Function (see 04-RESEARCH.md Edge Function example)
   - Parse webhook payload (type, table, record)
   - Only process INSERT on signals table
   - Only process if signal.priority matches user's threshold
   - Fetch user profile and notification_preferences
   - Check if email_enabled and signal_type in allowed types
   - If all checks pass, POST to /api/send-notification
   - Return appropriate response for each skip/send case
   - Include error handling and logging
  </action>
  <verify>
    npm run build && echo "Build passes with email components"
  </verify>
  <done>Email template exists, API route handles send, Edge Function evaluates preferences and triggers email</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Settings page accessible at /dashboard/settings
3. Notification preferences save to profiles table
4. Email template renders (can preview with react-email dev server)
5. API route returns 200 with valid Resend response
6. Edge Function file exists and is syntactically valid
</verification>

<success_criteria>
- User can access Settings page from dashboard
- User can toggle email notifications and select signal types
- Save button persists preferences to Supabase
- React Email template exists with brand styling
- API route sends email via Resend
- Edge Function evaluates preferences before sending
- All files pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/04-automation-hardening/04-02-SUMMARY.md`
</output>

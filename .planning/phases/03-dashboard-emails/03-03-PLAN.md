---
phase: 03-dashboard-emails
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/api/stats/route.ts
  - src/app/dashboard/page.tsx
  - src/lib/queries/stats.ts
  - src/hooks/use-realtime-signals.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard stats show accurate counts (total, by type, by priority)"
    - "New signals appear without page refresh (real-time)"
    - "Recent signals section shows latest 5 signals"
  artifacts:
    - path: "src/app/api/stats/route.ts"
      provides: "GET endpoint for dashboard statistics"
      exports: ["GET"]
    - path: "src/lib/queries/stats.ts"
      provides: "Stats aggregation queries"
      exports: ["fetchDashboardStats"]
    - path: "src/hooks/use-realtime-signals.ts"
      provides: "Supabase realtime subscription hook"
      exports: ["useRealtimeSignals"]
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard with live stats and recent signals"
      min_lines: 80
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "/api/stats"
      via: "fetch stats"
      pattern: "fetch.*api/stats"
    - from: "src/hooks/use-realtime-signals.ts"
      to: "supabase.channel"
      via: "realtime subscription"
      pattern: "channel.*signals"
---

<objective>
Add live dashboard stats and real-time signal updates using Supabase Realtime.

Purpose: Dashboard currently shows placeholder dashes. Users need accurate stats and real-time updates so they see new signals immediately without refreshing.

Output: Dashboard with live stats, recent signals section, and real-time updates.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-dashboard-emails/03-01-SUMMARY.md
@src/types/index.ts
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
@src/components/dashboard/stats-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stats API and query layer</name>
  <files>
    src/lib/queries/stats.ts
    src/app/api/stats/route.ts
  </files>
  <action>
Create `src/lib/queries/stats.ts`:
- Export async function `fetchDashboardStats(supabase, userId: string): Promise<DashboardStats>`
- Query for aggregated stats in a single RPC or multiple queries:
  - Total signals: count where user_id = userId
  - New signals: count where status = 'new'
  - High priority: count where priority = 'high'
  - Signals by type: group by signal_type, count
  - Signals by day (last 7 days): group by date(detected_at), count
- Calculate conversion rate: (converted count / total count) * 100
- Return DashboardStats object matching the type in @/types

Create `src/app/api/stats/route.ts`:
- Export async GET handler
- Get authenticated user
- Call fetchDashboardStats
- Return JSON stats object
- Handle errors with 500 response

Use efficient queries - aggregate in database, not in JS.
For signals_by_type, use: `SELECT signal_type, count(*) FROM signals WHERE user_id = $1 GROUP BY signal_type`
  </action>
  <verify>
`npx tsc --noEmit` passes. GET /api/stats returns DashboardStats JSON.
  </verify>
  <done>
Stats API returns accurate aggregated statistics from database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create realtime signals hook</name>
  <files>
    src/hooks/use-realtime-signals.ts
  </files>
  <action>
Create `src/hooks/use-realtime-signals.ts`:
- Export hook `useRealtimeSignals(userId: string, onNewSignal: (signal: Signal) => void)`
- Use Supabase client (browser client)
- Subscribe to signals table INSERT events filtered by user_id
- Call onNewSignal callback when new signal received
- Return cleanup function to unsubscribe
- Handle connection errors gracefully

Implementation:
```typescript
const channel = supabase
  .channel('signals-realtime')
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'signals',
      filter: `user_id=eq.${userId}`
    },
    (payload) => onNewSignal(payload.new as Signal)
  )
  .subscribe();
```

Return unsubscribe on cleanup.

Note: Requires Supabase Realtime to be enabled for signals table (it is by default for Supabase projects).
  </action>
  <verify>
`npx tsc --noEmit` passes. Hook file exists with proper exports.
  </verify>
  <done>
Realtime hook subscribes to new signal inserts and triggers callback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire dashboard to show live stats and recent signals</name>
  <files>
    src/app/dashboard/page.tsx
  </files>
  <action>
Rewrite `src/app/dashboard/page.tsx`:

1. Make it a client component ("use client") for realtime
2. Add state for: stats, recentSignals, loading
3. Fetch stats from /api/stats on mount
4. Fetch recent 5 signals from /api/signals?limit=5 on mount
5. Use useRealtimeSignals hook to listen for new signals:
   - On new signal: prepend to recentSignals list, increment stats.total_signals and stats.new_signals
6. Update StatsCard components to show real values:
   - Total Signals: stats.total_signals
   - High Priority: stats.high_priority
   - Conversion Rate: stats.conversion_rate + '%'
   - Emails Drafted: query generated_emails count (add to stats query)
7. Replace empty state with actual SignalCard components for recent signals
8. Keep "View all" link to /dashboard/signals
9. Show skeleton loading states initially

Add visual indicator when new signal arrives (brief highlight animation).

Keep existing Quick Actions section.
  </action>
  <verify>
Navigate to /dashboard, see real stats instead of dashes. Recent signals section shows actual signals.
  </verify>
  <done>
Dashboard shows live statistics and recent signals with real-time updates.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No type errors
2. `npm run build` - Build succeeds
3. Manual test: Navigate to /dashboard as logged-in user
4. Verify: Stats show real numbers (or 0 if no signals)
5. Verify: Recent signals section shows latest signals
6. Verify: Insert signal via SQL/worker -> appears in dashboard without refresh
7. Verify: Stats update when new signal arrives
</verification>

<success_criteria>
- Dashboard stats show accurate counts from database
- Total Signals, High Priority, Conversion Rate, Emails Drafted all populated
- Recent signals section shows latest 5 signals
- Clicking signal in recent section navigates to detail
- New signals appear in real-time without page refresh
- Stats increment when new signal arrives
- Loading skeletons show during initial fetch
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-emails/03-03-SUMMARY.md`
</output>

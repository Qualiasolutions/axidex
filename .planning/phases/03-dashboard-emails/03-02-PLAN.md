---
phase: 03-dashboard-emails
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/api/signals/[id]/route.ts
  - src/app/api/signals/[id]/email/route.ts
  - src/app/dashboard/signals/[id]/page.tsx
  - src/lib/ai/email-generator.ts
autonomous: true

user_setup:
  - service: anthropic
    why: "AI email generation using Claude"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key"

must_haves:
  truths:
    - "User can click signal to view full details"
    - "User can generate personalized email for any signal"
    - "User can copy generated email to clipboard"
    - "Email generation uses Claude for personalization"
  artifacts:
    - path: "src/app/api/signals/[id]/route.ts"
      provides: "GET single signal by ID"
      exports: ["GET"]
    - path: "src/app/api/signals/[id]/email/route.ts"
      provides: "POST to generate email for signal"
      exports: ["POST"]
    - path: "src/app/dashboard/signals/[id]/page.tsx"
      provides: "Signal detail view with email generation"
      min_lines: 80
    - path: "src/lib/ai/email-generator.ts"
      provides: "Claude-powered email generation"
      exports: ["generateEmail"]
  key_links:
    - from: "src/app/dashboard/signals/[id]/page.tsx"
      to: "/api/signals/[id]"
      via: "fetch signal details"
      pattern: "fetch.*api/signals/"
    - from: "src/app/api/signals/[id]/email/route.ts"
      to: "src/lib/ai/email-generator.ts"
      via: "import generateEmail"
      pattern: "import.*generateEmail"
    - from: "src/lib/ai/email-generator.ts"
      to: "anthropic"
      via: "Anthropic SDK"
      pattern: "new Anthropic|anthropic\\.messages"
---

<objective>
Build signal detail view with AI-powered email generation using Claude.

Purpose: Users need to see full signal context and generate personalized outreach emails. Claude generates relevant, contextual emails based on the signal data.

Output: Signal detail page with email generation button, Claude integration for AI emails.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-dashboard-emails/03-01-SUMMARY.md
@src/types/index.ts
@src/lib/supabase/server.ts
@supabase/migrations/001_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create signal detail API and page</name>
  <files>
    src/app/api/signals/[id]/route.ts
    src/app/dashboard/signals/[id]/page.tsx
  </files>
  <action>
Create `src/app/api/signals/[id]/route.ts`:
- Export async GET handler with `{ params }` receiving signal id
- Get authenticated user from Supabase session
- Query signals table where id matches AND user_id matches (RLS backup)
- Return 404 if not found
- Return signal JSON

Create `src/app/dashboard/signals/[id]/page.tsx`:
- Server component (no "use client") for initial load
- Fetch signal from API or directly from Supabase server client
- Display full signal details:
  - Company name, domain, logo (if available)
  - Signal type and priority badges
  - Full title and summary (not truncated)
  - Source URL as clickable link
  - Detected date formatted
  - Metadata fields (funding_amount, job_titles, location, etc)
- "Back to Signals" link
- "Generate Email" button (client component island)
- Section for generated email (initially empty, populated after generation)
- Copy to clipboard button for email

Use Header component for page header.
Use existing Badge components for type/priority.
Use motion for entrance animations.
  </action>
  <verify>
Navigate to /dashboard/signals/[valid-id], page loads with full signal details.
  </verify>
  <done>
Signal detail page displays all signal information including metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Claude email generator</name>
  <files>
    src/lib/ai/email-generator.ts
    package.json
  </files>
  <action>
Install Anthropic SDK:
`npm install @anthropic-ai/sdk`

Create `src/lib/ai/email-generator.ts`:
- Import Anthropic from @anthropic-ai/sdk
- Export async function `generateEmail(signal: Signal, tone: 'professional' | 'casual' | 'enthusiastic' = 'professional'): Promise<{ subject: string; body: string }>`
- Create Anthropic client with ANTHROPIC_API_KEY env var
- Build prompt that includes:
  - Signal type (hiring/funding/etc)
  - Company name
  - Signal title and summary
  - Metadata (funding amount, job titles, etc if available)
  - Requested tone
- Use Claude claude-3-5-sonnet-20241022 model for speed/quality balance
- System prompt: "You are a sales development rep writing personalized outreach emails. Write concise, relevant emails that reference the specific signal/news. No generic templates."
- Parse response to extract subject and body
- Handle API errors gracefully, return error message

Consider token limits: max_tokens 500 should be enough for a short email.
  </action>
  <verify>
`npx tsc --noEmit` passes. File exports generateEmail function.
  </verify>
  <done>
Email generator module calls Claude API and returns subject + body.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create email generation API and wire to UI</name>
  <files>
    src/app/api/signals/[id]/email/route.ts
    src/app/dashboard/signals/[id]/page.tsx
  </files>
  <action>
Create `src/app/api/signals/[id]/email/route.ts`:
- Export async POST handler
- Get authenticated user
- Fetch signal by ID (verify ownership)
- Parse request body for optional tone parameter
- Call generateEmail(signal, tone)
- Save generated email to generated_emails table:
  - signal_id, user_id, subject, body, tone
- Return { id, subject, body, tone }
- Handle errors with appropriate status codes

Update `src/app/dashboard/signals/[id]/page.tsx`:
- Add client component for email generation: `EmailGenerator`
- Props: signalId, existingEmail (if previously generated)
- State: loading, email, error
- Tone selector (professional/casual/enthusiastic)
- "Generate Email" button triggers POST to /api/signals/[id]/email
- Display generated email with subject and body
- "Copy to Clipboard" button using navigator.clipboard.writeText()
- Show toast/notification on copy success
- "Regenerate" button to generate new email

Load any existing generated email for this signal on page load.
  </action>
  <verify>
Click "Generate Email" on signal detail page, see loading state, then generated email appears. Click copy, email copied to clipboard.
  </verify>
  <done>
Users can generate AI emails for any signal and copy them to clipboard.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No type errors
2. `npm run build` - Build succeeds
3. Manual test: Navigate to /dashboard/signals, click any signal
4. Verify: Signal detail page shows full information
5. Verify: Click "Generate Email" -> loading -> email appears
6. Verify: Click "Copy" -> email in clipboard
7. Verify: Refresh page -> previously generated email still shown
</verification>

<success_criteria>
- Signal detail page accessible via /dashboard/signals/[id]
- Full signal information displayed (not truncated)
- Metadata fields shown when available
- Email generation works with Claude
- Three tone options available (professional/casual/enthusiastic)
- Generated email saved to database
- Copy to clipboard works
- Previously generated emails load on revisit
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-emails/03-02-SUMMARY.md`
</output>

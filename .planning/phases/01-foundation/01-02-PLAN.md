---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/signup/page.tsx
  - src/app/(auth)/forgot-password/page.tsx
  - src/app/(auth)/auth/callback/route.ts
  - src/app/(auth)/layout.tsx
  - src/middleware.ts
  - src/lib/supabase/middleware.ts
  - src/components/layout/sidebar.tsx
autonomous: true

user_setup:
  - service: supabase
    why: "Authentication requires Supabase project configured"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public"
    dashboard_config:
      - task: "Enable email auth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"
      - task: "Configure site URL for redirects"
        location: "Supabase Dashboard -> Authentication -> URL Configuration"
      - task: "Apply database migrations"
        location: "Supabase Dashboard -> SQL Editor (paste 001_schema.sql and 002_rls.sql)"

must_haves:
  truths:
    - "User can sign up with email and password"
    - "User can log in and stay logged in across browser sessions"
    - "User can log out from any dashboard page"
    - "User can request password reset and receive email"
    - "Unauthenticated users are redirected to login"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login form UI"
      contains: "signInWithPassword"
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Signup form UI"
      contains: "signUp"
    - path: "src/middleware.ts"
      provides: "Route protection"
      contains: "updateSession"
    - path: "src/lib/supabase/middleware.ts"
      provides: "Supabase session refresh middleware"
      contains: "createServerClient"
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "supabase.auth.signInWithPassword"
      via: "form submit handler"
      pattern: "signInWithPassword"
    - from: "src/middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "updateSession import"
      pattern: "import.*updateSession.*middleware"
    - from: "src/components/layout/sidebar.tsx"
      to: "supabase.auth.signOut"
      via: "logout button onClick"
      pattern: "signOut"
---

<objective>
Implement Supabase Auth with login, signup, password reset, and route protection.

Purpose: Users need secure accounts to access their personalized signals. Without auth, the dashboard is public and data cannot be scoped per-user.

Output: Working auth flow where users can register, login, stay logged in, logout, and reset passwords.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
@src/app/dashboard/layout.tsx
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth pages and layout</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/signup/page.tsx
    src/app/(auth)/forgot-password/page.tsx
    src/app/(auth)/auth/callback/route.ts
  </files>
  <action>
Create auth route group with centered card layout and forms.

**Auth Layout (`src/app/(auth)/layout.tsx`):**
```tsx
export default function AuthLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-[var(--bg-secondary)] px-4">
      <div className="w-full max-w-md">
        {children}
      </div>
    </div>
  );
}
```

**Login Page (`src/app/(auth)/login/page.tsx`):**
- "use client" directive (form interactions)
- Card with logo/title "Sign in to Axidex"
- Email input (type="email", required)
- Password input (type="password", required)
- Submit button using existing Button component
- Link to signup: "Don't have an account? Sign up"
- Link to forgot password: "Forgot password?"
- Error state displayed below form
- Loading state on button during submission
- On success: redirect to `/dashboard` using `router.push`
- Use `createClient()` from `@/lib/supabase/client`
- Call `supabase.auth.signInWithPassword({ email, password })`

**Signup Page (`src/app/(auth)/signup/page.tsx`):**
- Same structure as login
- Title: "Create your account"
- Email, password, confirm password inputs
- Full name input (optional)
- Call `supabase.auth.signUp({ email, password, options: { data: { full_name } } })`
- On success: Show "Check your email for confirmation link" message
- Link to login: "Already have an account? Sign in"

**Forgot Password Page (`src/app/(auth)/forgot-password/page.tsx`):**
- Email input only
- Call `supabase.auth.resetPasswordForEmail(email, { redirectTo: `${origin}/auth/callback?next=/update-password` })`
- On success: Show "Check your email for reset link"
- Link back to login

**Auth Callback Route (`src/app/(auth)/auth/callback/route.ts`):**
```tsx
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  const next = searchParams.get('next') ?? '/dashboard'

  if (code) {
    const supabase = await createClient()
    const { error } = await supabase.auth.exchangeCodeForSession(code)
    if (!error) {
      return NextResponse.redirect(`${origin}${next}`)
    }
  }

  return NextResponse.redirect(`${origin}/login?error=auth_failed`)
}
```

Style all forms consistently with:
- White card background with subtle border
- Orange accent for primary buttons
- Gray text for links
- Red text for error messages
- Subtle animations using Motion (FadeIn on mount)
  </action>
  <verify>
Pages render without errors:
- `npm run dev` then visit /login, /signup, /forgot-password
- Forms display with all fields and buttons
  </verify>
  <done>All auth pages exist with forms, auth callback route handles email confirmation redirects</done>
</task>

<task type="auto">
  <name>Task 2: Create middleware for session management and route protection</name>
  <files>
    src/middleware.ts
    src/lib/supabase/middleware.ts
  </files>
  <action>
Create Supabase middleware for session refresh and route protection.

**Supabase Middleware Helper (`src/lib/supabase/middleware.ts`):**
```tsx
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  const {
    data: { user },
  } = await supabase.auth.getUser()

  return { user, supabaseResponse }
}
```

**Root Middleware (`src/middleware.ts`):**
```tsx
import { updateSession } from '@/lib/supabase/middleware'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  const { user, supabaseResponse } = await updateSession(request)

  // Protected routes - require authentication
  if (request.nextUrl.pathname.startsWith('/dashboard')) {
    if (!user) {
      const url = request.nextUrl.clone()
      url.pathname = '/login'
      url.searchParams.set('redirect', request.nextUrl.pathname)
      return NextResponse.redirect(url)
    }
  }

  // Auth routes - redirect to dashboard if already logged in
  if (['/login', '/signup', '/forgot-password'].includes(request.nextUrl.pathname)) {
    if (user) {
      return NextResponse.redirect(new URL('/dashboard', request.url))
    }
  }

  return supabaseResponse
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

This ensures:
- Sessions are refreshed on every request (prevents expiry)
- `/dashboard/*` routes require authentication
- Auth pages redirect to dashboard if already logged in
  </action>
  <verify>
- Unauthenticated visit to /dashboard redirects to /login
- Authenticated visit to /login redirects to /dashboard
- Run `npx tsc --noEmit` - no type errors
  </verify>
  <done>Middleware protects dashboard routes and redirects appropriately</done>
</task>

<task type="auto">
  <name>Task 3: Add logout to sidebar and wire auth state</name>
  <files>src/components/layout/sidebar.tsx</files>
  <action>
Update the existing sidebar component to:

1. Display user info at bottom of sidebar:
   - User's email or name
   - Small avatar placeholder (initials)

2. Add logout button that:
   - Calls `supabase.auth.signOut()`
   - Redirects to `/login` after signout
   - Shows loading state during signout

3. Make sidebar a client component ("use client") since it needs to:
   - Call Supabase auth methods
   - Handle click events

4. Fetch user on mount:
   ```tsx
   const [user, setUser] = useState<User | null>(null)

   useEffect(() => {
     const supabase = createClient()
     supabase.auth.getUser().then(({ data }) => setUser(data.user))
   }, [])
   ```

5. Logout handler:
   ```tsx
   const handleLogout = async () => {
     setLoading(true)
     const supabase = createClient()
     await supabase.auth.signOut()
     router.push('/login')
   }
   ```

Style the user section at bottom of sidebar:
- Horizontal divider above
- User email truncated if too long
- Logout button with icon (lucide-react LogOut icon)
- Hover state on logout
  </action>
  <verify>
- Sidebar shows user email when logged in
- Clicking logout signs out and redirects to login
- Run app with `npm run dev` and test full flow
  </verify>
  <done>Sidebar displays current user and functional logout button works from any dashboard page</done>
</task>

</tasks>

<verification>
Full auth flow test:
1. Visit `/dashboard` while logged out -> redirects to `/login`
2. Click "Sign up" -> fill form -> submit -> "Check email" message
3. (In development: check Supabase dashboard for confirmation link, or disable email confirmation)
4. Visit `/login` -> enter credentials -> submit -> redirects to `/dashboard`
5. Close browser, reopen, visit `/dashboard` -> still logged in (session persisted)
6. Click logout in sidebar -> redirects to `/login`
7. Visit `/forgot-password` -> enter email -> submit -> "Check email" message
</verification>

<success_criteria>
- [ ] Login page at `/login` with email/password form
- [ ] Signup page at `/signup` with email/password/name form
- [ ] Forgot password page at `/forgot-password`
- [ ] Auth callback route handles email confirmations
- [ ] Middleware redirects unauthenticated users from `/dashboard/*` to `/login`
- [ ] Middleware redirects authenticated users from auth pages to `/dashboard`
- [ ] Sidebar shows logged-in user's email
- [ ] Logout button in sidebar works and redirects to `/login`
- [ ] Sessions persist across browser restarts
- [ ] `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
